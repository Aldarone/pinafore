<!-- Component that uses a pool of sub-components under the hood, to avoid
     the cost of re-creating the component over and over again -->
<div class={parentClassName} ref:parent></div>
<script>
  import Queue from 'tiny-queue'
  import { store } from '../_store/store'
  import { mark, stop } from '../_utils/marks'
  const poolsByConstructor = new Map()

  if (process.browser && process.env.NODE_ENV !== 'production') {
    window.poolsByConstructor = poolsByConstructor
  }

  export default {
    oncreate () {
      let { Component, componentData, className } = this.get()
      let { parent } = this.refs

      let pool = poolsByConstructor.get(Component)
      if (!pool) {
        pool = new Queue()
        poolsByConstructor.set(Component, pool)
      }

      let poolItem = pool.shift()
      let component
      let node
      if (poolItem) {
        mark('reusePooledComponent')
        node = poolItem.node
        component = poolItem.component
        component.set(componentData)
        stop('reusePooledComponent')
      } else {
        mark('createPooledComponent')
        node = document.createElement('div')
        component = new Component({
          data: componentData,
          store,
          target: node
        })
        stop('createPooledComponent')
      }
      if (className) {
        node.setAttribute('class', className)
      }
      parent.appendChild(node)
      this.set({ component, node })
    },
    ondestroy () {
      let { Component, component, node } = this.get()
      let { parent } = this.refs
      parent.removeChild(node)
      let pool = poolsByConstructor.get(Component)
      pool.push({ component, node })
    },
    data: () => ({
      className: '',
      parentClassName: ''
    })
  }
</script>
