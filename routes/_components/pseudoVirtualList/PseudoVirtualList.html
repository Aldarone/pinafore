<div class="pseudo-virtual-list" on:initialized ref:node>
  {#each safeItems as item, i (item)}
    <PseudoVirtualListLazyItem
      {component}
      index={i}
      {length}
      {makeProps}
      key={item}
      on:initialized="itemInitialized()"
    />
  {/each}
</div>
<style>
  .pseudo-virtual-list {
    position: relative;
  }
</style>
<script>
  import PseudoVirtualListLazyItem from './PseudoVirtualListLazyItem.html'
  import { pseudoVirtualListStore } from './pseudoVirtualListStore'

  export default {
    oncreate () {
      let { realm } = this.get()
      this.store.setCurrentRealm(realm)
    },
    ondestroy () {
      this.store.setCurrentRealm(null)
    },
    methods: {
      itemInitialized () {
        let { initializedCount, length } = this.get()
        initializedCount++
        this.set({initializedCount})
        if (initializedCount === length) {
          this.initialize()
        }
      },
      initialize () {
        let { scrollToItem } = this.get()
        let { node } = this.refs
        if (scrollToItem && node) {
          this.scrollToPosition(node.querySelector(`[pseudo-virtual-list-key="${scrollToItem}"]`))
        } else {
          this.fire('initialized')
        }
      },
      scrollToPosition (element) {
        requestAnimationFrame(() => {
          console.log('scrolling element into view')
          element.scrollIntoView(true)
          this.fire('initialized')
        })
      }
    },
    data: () => ({
      initializedCount: 0
    }),
    computed: {
      safeItems: ({ items }) => items || [],
      length: ({ safeItems }) => safeItems.length
    },
    components: {
      PseudoVirtualListLazyItem
    },
    store: () => pseudoVirtualListStore
  }
</script>